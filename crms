#!/usr/bin/env python3

import sys
import os
# import pathlib
import git
from git import Repo
import subprocess
import argparse
import yaml

import firebase_admin
from firebase_admin import credentials
from firebase_admin import firestore

def crms_conf(args):

    dir_path = os.getcwd()
    #### CRMS Config Directory
    path_crms = os.path.join(dir_path, ".crms")
    if not os.path.exists(path_crms) :
        os.makedirs(path_crms)
        print("The new .crms directory is created !!!")

    #### CRMS Config File
    configs = { 'git': {'remote' : args.git_remote }, 
                'dvc' : {'remote': args.dvc_remote }} 
    
    path_config = os.path.join(path_crms, "config")
    with open(path_config, 'w') as f:
        yaml.dump(configs, f, sort_keys=False)


    # with open(path_config, "wt") as f :
    #     f.write("[git]\n")
    #     f.write("    remote = {}\n".format(args.git_remote_url))
    #     f.write("[dvc]\n")
    #     f.write("    remote = {}\n".format(args.dvc_remote_base))
    
    print("CRMS Configurations are stored into .crms/config !!!")
    

def crms_conf_mod(args):
    
    dir_path = os.getcwd()
    #### CRMS Config Directory
    path_config = os.path.join(dir_path, ".crms", "config")
    if not os.path.exists(path_config) :
        print("CRMS ERROR: crms conf must be called before crms conf_mod")
        sys.exit(-1)

    #### Read CRMS Config File
    with open(path_config) as f:
        configs = yaml.load(f, Loader=yaml.FullLoader)

    args_dict = vars(args)

    if 'git_remote' in args_dict and args.git_remote != '':
        configs['git']['remote'] = args.git_remote
        if 'model' in configs :         # if crms init was called --> model exists
            set_git_remote(args.git_remote)
        else :
            print("git_remote: model is not in config")

    if 'dvc_remote' in args_dict and args.dvc_remote != '' :
        configs['dvc']['remote'] = args.dvc_remote
        if 'model' in configs :          # if crms init was called --> model exists   
            set_dvc_remote(args.dvc_remote)
        else :
            print("dvc_remote: model is not in config")


    with open(path_config, 'w') as f:
        yaml.dump(configs, f, sort_keys=False)


    # with open(path_config, "wt") as f :
    #     f.write("[git]\n")
    #     f.write("    remote = {}\n".format(args.git_remote_url))
    #     f.write("[dvc]\n")
    #     f.write("    remote = {}\n".format(args.dvc_remote_base))
    
    print("CRMS Configurations are modified !!!")

def set_dvc_remote(dvc_remote):
    #### DVC Remote Add
    p = subprocess.run(["dvc", "remote", "remove",  "storage", "--quiet" ])
    p = subprocess.run(["dvc", "remote", "add",  "-d", "storage", dvc_remote, "--quiet" ])
    # print("Return code : {} = {}".format(type(p.returncode), p.returncode))
    if p.returncode == 0 : # success of subprocess.run
        print("CRMS added DVC remote (" + dvc_remote + ")")
    else: # fail of subprocess.run
        print("CRMS failed to DVC add remote...")
        sys.exit(-1)

def set_git_remote(git_remote):
    dir_path = os.getcwd()
    try :
        repo = Repo(dir_path)
    except git.exc.InvalidGitRepositoryError:
        repo = Repo.init(dir_path)        
        print("CRMS uses Git Local Repository (" + dir_path + ")")        
        print("Git initialized...")
    except git.exc.NoSuchPathError :
        print("Error: git repoistory path could not be accessed by the system.")
        sys.exit(-1)
    except :
        print("Error: Unknown error occured while crms init")
        sys.exit(-1)

    #### git remote add origin ~~~~   # 'git remote add origin ~~ '  must be prepared before 'crms init'
    if len(repo.remotes) > 0 :
        repo.delete_remote('origin')

    origin = repo.create_remote('origin', git_remote)
    print("CRMS added Git remote (" + git_remote + ")")

def crms_init(args):

    dir_path = os.getcwd()
    #### Checke CRMS Config File Existence
    path_config = os.path.join(dir_path, ".crms", "config")
    if not os.path.exists(path_config) :
        print("CRMS ERROR: crms conf must be called before crms init")
        sys.exit(-1)

    #### Add model_name to crms config file 
    with open(path_config) as f:
        configs = yaml.load(f, Loader=yaml.FullLoader)
        print(configs)

    configs['model'] = {'name': args.model_name}
    with open(path_config, 'w') as f:
        yaml.dump(configs, f, sort_keys=False)

    
    #### Git Repository 
    set_git_remote(configs['git']['remote'])

    # try :
    #     repo = Repo(dir_path)  # 'git init '  must be prepared before 'crms init'
    # except git.exc.InvalidGitRepositoryError:
    #     repo = Repo.init(dir_path)        
    #     print("Git initialized...")
    # except git.exc.NoSuchPathError :
    #     print("Error: git repoistory path could not be accessed by the system.")
    #     sys.exit(-1)
    # except :
    #     print("Error: Unknown error occured while crms init")
    #     sys.exit(-1)
    # finally :
    #     print("CRMS uses Git Local Repository (" + dir_path + ")")        

    # #### git remote add origin ~~~~   # 'git remote add origin ~~ '  must be prepared before 'crms init'
    # if len(repo.remotes) > 0 :
    #     repo.delete_remote('origin')

    # origin = repo.create_remote('origin', configs['git']['remote'])


    #### DVC INIT
    p = subprocess.run(["dvc", "init", "--force", "--quiet"])
    # print("Return code : {} = {}".format(type(p.returncode), p.returncode))
    if p.returncode == 0 : # success of subprocess.run
        print("CRMS initialized DVC...")
    else: # fail of subprocess.run
        print("CRMS failed of DVC initialization...")
        sys.exit(-1)

    #### DVC Remote Add
    set_dvc_remote(configs['dvc']['remote'])

#     remotes = repo.remotes # [<git.Remote "origin">, ...]
#     if len(remotes) <= 0 :
#         print("!!!! git remote origin must be added after crms init.")
#         print("!!!! Try: git remote add origin git@github.com:<user_name>/<repository_name.git>")    
# #        sys.exit(-1)
#         pass
#     else:
#         origin = remotes[0]   # <git.Remote "origin">
#         urls = origin.urls    # <generator object Remote.urls at 0x7fa164d235f0>
#         url = next(urls)
#         print("CRMS uses Git Remote (" + url + ")")
#         # with open(path_config, "at+") as f :
#         #     f.write("git_remote : {}\n".format(url))


    firebase_options = {'projectId':'gcp-test-710302'}
    firebase_app = firebase_admin.initialize_app(options=firebase_options)
    db = firestore.client()
    doc_ref = db.collection('models').document(args.model_name)   # DocumentReference
    doc_ref.set({'git_repository': configs['git']['remote'], 'dvc_repository':configs['dvc']['remote']})


def crms_add(args):
    # List to be added to Git
    git_add_list = ['.dvcignore', '.dvc/config', '.gitignore', '.crms/config']  # + *.dvc

    # Check model files to be added
    model_files = args.model_files
    if len(model_files) == 0 :
        print("Error: File list is required to be added.")

    #### Check CRMS Config File Existence
    dir_path = os.getcwd()
    path_config = os.path.join(dir_path, ".crms", "config")
    if not os.path.exists(path_config) :
        print("CRMS ERROR: crms conf must be called before crms init")
        sys.exit(-1)

    #### Add model_name to crms config file 
    with open(path_config) as f:
        configs = yaml.load(f, Loader=yaml.FullLoader)

    if 'model' not in configs :          # if crms init was called --> model exists   
        print("Error: crms init must be called before crms add")

    # open git repo
    dir_path = os.getcwd()
    try :
        repo = Repo(dir_path)  # 'git init'  must be prepared before 'crms init'
    except git.exc.InvalidGitRepositoryError:
        print("Error: Invalid Git Repository. Check crms init was called...")
        sys.exit(-1)
    except git.exc.NoSuchPathError :
        print("Error: git repoistory path could not be access by the system.")
        sys.exit(-1)
    except :
        print("Error: Unknown error occured while crms push")
        sys.exit(-1)

    # dvc add
    p = subprocess.run(["dvc", "add"]  + model_files)
    # print("Return code : {} = {}".format(type(p.returncode), p.returncode))
    if p.returncode == 0 : # success of subprocess.run
        print("CRMS added model files(" + ', '.join(s for s in model_files) + ") to DVC")
    else: # fail of subprocess.run
        print("CRMS failed to add model files...")
        sys.exit(-1)

    # add git_add_list files to git repo index
    for file_name in model_files :
        git_add_list.append( file_name + '.dvc') 

    repo.index.add(git_add_list)
    commitMsg="CRMS model files(" + ', '.join(s for s in model_files) + ") for model(" + configs['model']['name'] + ") are added."
    repo.index.commit(commitMsg)
    print("CRMS added auxiliary files(" + ', '.join(s for s in git_add_list) + ") to GIT")


def crms_push(args):

    #### Check CRMS Config File Existence
    dir_path = os.getcwd()
    path_config = os.path.join(dir_path, ".crms", "config")
    if not os.path.exists(path_config) :
        print("CRMS ERROR: crms conf was not called")
        sys.exit(-1)

    #### Add model_name to crms config file 
    with open(path_config) as f:
        configs = yaml.load(f, Loader=yaml.FullLoader)

    if 'model' not in configs :          # if crms init was called --> model exists   
        print("Error: crms init was not called")

    # open git repo
    dir_path = os.getcwd()
    try :
        repo = Repo(dir_path)  # 'git init'  must be prepared before 'crms init'
    except git.exc.InvalidGitRepositoryError:
        print("Error: Invalid Git Repository. Check crms init was called...")
        sys.exit(-1)
    except git.exc.NoSuchPathError :
        print("Error: git repoistory path could not be access by the system.")
        sys.exit(-1)
    except :
        print("Error: Unknown error occured while crms push")
        sys.exit(-1)

    remotes = repo.remotes # [<git.Remote "origin">, ...]
    if len(remotes) <= 0 :
        print("Error: git remote origin must be added before crms push.")
        print("Try: git remote add origin git@github.com:<user_name>/<repository_name.git>")    
        sys.exit(-1)


    tagName = args.version
    print("Creating TagReference.")
    git.refs.tag.TagReference.create(repo, tagName)

    #origin = repo.remotes.origin
    remote_origin = repo.remotes[0]   # repo.remotes.origin (=origin)
    print("Push to main of remote " + remote_origin.name)

    #origin.push('main')
    remote_origin.push(repo.active_branch.name)   # main

    print("Push tag : " + tagName)
    remote_origin.push(tagName)


    # origin = remotes[0]   # <git.Remote "origin">
    # urls = origin.urls    # <generator object Remote.urls at 0x7fa164d235f0>
    # url = next(urls)

    # print("Git Repository URL : " + url)

    # # p = subprocess.run(["dvc", "init"])
    # pass


    #### DVC Push
    p = subprocess.run(["dvc", "push"])
    # print("Return code : {} = {}".format(type(p.returncode), p.returncode))
    if p.returncode == 0 : # success of subprocess.run
        print("CRMS pushes to DVC...")
    else: # fail of subprocess.run
        print("CRMS failed of DVC Push...")
        sys.exit(-1)


    firebase_options = {'projectId':'gcp-test-710302'}
    firebase_app = firebase_admin.initialize_app(options=firebase_options)
    db = firestore.client()
    doc_ref = db.collection('models').document(configs['model']['name'])   # DocumentReference
    doc_ref.update({'latest':tagName, 'versions':firestore.ArrayUnion([tagName])})


    print("CRMS PUSHED....")

def crms_pull(args):
    print("CRMS PULL....")
    
    if args.target != '' :
        target = args.target
    else :
        # target = os.path.join( os.getcwd(), args.model_name)
        # target = os.path.join( os.getcwd(), "model_crms")
        target = os.path.join( os.getcwd(), os.path.basename(args.model_url).split('.')[0] )   # git@github.com:jangcs/KKK.git -> KKK.git -> ['KKK', 'git']
        
    # repo = Repo.clone_from("git@github.com:jangcs/KKK.git", os.getcwd() )
    repo = Repo.clone_from(args.model_url, target )

    if args.version == 'latest' : 
        os.chdir(target)
        p = subprocess.run(["dvc", "pull"])
        if p.returncode == 0 : # success of subprocess.run
            print("CRMS pulled model files from DVC to " + target)
        else: # fail of subprocess.run
            print("CRMS failed to pull model files...")
            sys.exit(-1)
    else :
        past_branch = repo.create_head('crms_target', args.version)
        repo.heads.crms_target.checkout()

        os.chdir(target)
        p = subprocess.run(["dvc", "pull"])
        if p.returncode == 0 : # success of subprocess.run
            print("CRMS pulled model files from DVC to " + target)
        else: # fail of subprocess.run
            print("CRMS failed to pull model files...")
            sys.exit(-1)

        # repo.heads.master.checkout()
        # repo.delete_head('crms_target')


def crms_list(args):
    print("CRMS LIST....")
    
    firebase_options = {'projectId':'gcp-test-710302'}
    firebase_app = firebase_admin.initialize_app(options=firebase_options)
    db = firestore.client()
    doc_ref = db.collection('models').document(args.model_name)   # DocumentReference

    versions = doc_ref.get().to_dict()['versions']
    for v in versions :
        print(v)

    latest = doc_ref.get().to_dict()['latest']
    print('latest = ' + latest)
    


def crms(args):
    if args.cmd == 'conf':
        crms_conf(args)
    elif args.cmd == 'conf_mod' :
        crms_conf_mod(args)
    elif args.cmd == 'init' :
        crms_init(args)
    elif args.cmd == 'add' :
        crms_add(args)
    elif args.cmd == 'push' :
        crms_push(args)
    elif args.cmd == 'pull' :
        crms_pull(args)
    elif args.cmd == 'list' :
        crms_list(args)
    else :
        print("Unknown CMD")


def arg_parse() :
    arg_parser = argparse.ArgumentParser(prog="crms", description="Cloud Robot Model Sharing CLI")

    sub_parsers = arg_parser.add_subparsers(dest="cmd", help="sub-command help", required=True)
    
    parser_conf =   sub_parsers.add_parser('conf',  help="CRMS CONFIG : crms conf <git_remote_url> <dvc_remote_url>")
    parser_conf_mod =   sub_parsers.add_parser('conf_mod',  help="CRMS CONFIG MODIFY : crms conf_mod [-g <git_remote_url>] [-d <dvc_remote_url>]" )
    parser_init =   sub_parsers.add_parser('init',  help="CRMS INIT : crms init <model_name>" )
    parser_add  =   sub_parsers.add_parser('add',   help="CRMS ADDS MODEL_FILES: crms add <model_files>...")
    parser_push =   sub_parsers.add_parser('push',  help="CRMS PUSHES MODEL_FILES With VERSION_TAG : crms push <version>")
    parser_pull =   sub_parsers.add_parser('pull',  help="CRMS PULL MODEL With VERSION_TAG : crms pull <model_url> [--version=<latest>|<version_tag>] [--target=<target_dir>] ")
    parser_list =   sub_parsers.add_parser('list',  help="CRMS LIST MODEL Versions : crms list <model_name> ")

    parser_conf.add_argument("git_remote", type=str,  action="store", help="git_remote_url is required")
    parser_conf.add_argument("dvc_remote", type=str,  action="store", help="dvc_remote_url is required")

    parser_conf_mod.add_argument("-g", "--git_remote", type=str,  default="", action="store", help="--git_remote=<git_remote_url>")
    parser_conf_mod.add_argument("-d", "--dvc_remote", type=str,  default="", action="store", help="--dvc_remote=<dvc_remote_url>")

    parser_init.add_argument("model_name", type=str,  action="store", help="model_name is required")

    parser_add.add_argument("model_files", type=str,  action="store", nargs="*", help="model_files are required")

    parser_push.add_argument("version", type=str,  action="store", help="version is required")

    parser_pull.add_argument("model_url",  action="store", help="model_url is required")
    # parser_pull.add_argument("model_name",  action="store", help="model_name is required")
    parser_pull.add_argument("-v", "--version", type=str,  default="latest", action="store", help="--version=<latest>|<version_tag>")
    parser_pull.add_argument("-t", "--target", type=str,  default="", action="store", help="--target=<target_dir>")

    parser_list.add_argument("model_name",  action="store", help="model_nameis required")

    args = arg_parser.parse_args()
    return args


if __name__=='__main__':
    args = arg_parse()
    print(args)
    # print(dir(args))
    # print(type(args))
    crms(args)

